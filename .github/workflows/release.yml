name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  release:
    runs-on: macos-15
    steps:
      - uses: actions/checkout@v4

      - name: Install xcodegen
        run: brew install xcodegen

      - name: Generate Xcode project
        run: xcodegen generate

      - name: Get version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> "$GITHUB_OUTPUT"

      - name: Archive
        run: |
          xcodebuild archive \
            -project PasteClip.xcodeproj \
            -scheme PasteClip \
            -configuration Release \
            -archivePath build/PasteClip.xcarchive \
            CODE_SIGN_IDENTITY="-" \
            CODE_SIGNING_ALLOWED=NO \
            ONLY_ACTIVE_ARCH=NO

      - name: Extract app bundle
        run: |
          APP_PATH="build/PasteClip.xcarchive/Products/Applications/PasteClip.app"
          if [ ! -d "$APP_PATH" ]; then
            APP_PATH="build/PasteClip.xcarchive/Products/usr/local/bin/PasteClip.app"
          fi
          mkdir -p build/dmg
          cp -R "$APP_PATH" build/dmg/
          ln -s /Applications build/dmg/Applications

      - name: Create DMG
        run: |
          hdiutil create \
            -volname "PasteClip" \
            -srcfolder build/dmg \
            -ov \
            -format UDZO \
            "build/PasteClip-${{ steps.version.outputs.VERSION }}.dmg"

      - name: Calculate SHA256
        id: sha
        run: |
          SHA=$(shasum -a 256 "build/PasteClip-${{ steps.version.outputs.VERSION }}.dmg" | awk '{print $1}')
          echo "SHA256=$SHA" >> "$GITHUB_OUTPUT"
          echo "SHA256: $SHA"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: build/PasteClip-${{ steps.version.outputs.VERSION }}.dmg
          body: |
            ## PasteClip v${{ steps.version.outputs.VERSION }}

            ### Install

            **Homebrew:**
            ```
            brew install --cask --no-quarantine minsang-alt/tap/pasteclip
            ```

            **Manual:** Download `PasteClip-${{ steps.version.outputs.VERSION }}.dmg` below.

            ---
            SHA256: `${{ steps.sha.outputs.SHA256 }}`
          generate_release_notes: true
